<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE TURF ‚Äî Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
    <style>
        body {
            background-color: #0f1117;
            color: #edeef3;
        }

        .glass-dark {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar {
            min-height: 100vh;
            width: 350px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stats-card {
            background: linear-gradient(135deg, #111827, #0f1117);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .booking-item {
            transition: all 0.2s;
            border-radius: 0.75rem;
            border: 1px solid transparent;
        }

        .booking-item:hover {
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .booking-item.active {
            background: rgba(26, 107, 60, 0.15);
            border-color: rgba(26, 107, 60, 0.3);
        }

        .status-badge {
            font-weight: 800;
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            text-transform: uppercase;
            border-radius: 0.375rem;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background: #fbbf24;
            color: #451a03;
        }

        .status-confirmed {
            background: #1a6b3c;
            color: #f0fdf4;
        }

        .status-hold {
            background: #f97316;
            color: #fff7ed;
        }

        .status-rejected {
            background: #ef4444;
            color: #fef2f2;
        }
    </style>
</head>

<body class="overflow-hidden">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center glass-dark">
        <div class="bg-gray-900 p-8 rounded-3xl shadow-2xl border border-gray-800 w-full max-w-sm">
            <h2 class="text-2xl font-black mb-6 text-center text-emerald-500">THE TURF ADMIN</h2>
            <input type="password" id="adminPass" placeholder="Enter Password"
                class="w-full bg-gray-800 border-none rounded-xl p-4 mb-4 focus:ring-2 focus:ring-emerald-500 text-white font-bold">
            <button onclick="login()"
                class="w-full bg-emerald-600 hover:bg-emerald-500 p-4 rounded-xl font-black transition-all">SIGN
                IN</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden flex h-screen">

        <!-- Sidebar: Bookings List -->
        <div class="sidebar flex flex-col glass-dark h-full">
            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <h1 class="text-xl font-black tracking-tighter text-emerald-500">üèüÔ∏è THE TURF</h1>
                <span class="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Live Control Panel</span>
            </div>

            <!-- Filters -->
            <div class="flex p-2 gap-1 border-b border-white/5">
                <button onclick="setFilter('all')"
                    class="flex-1 text-[10px] font-black uppercase p-2 rounded-lg bg-white/5 hover:bg-white/10 transition">All</button>
                <button onclick="setFilter('pending')"
                    class="flex-1 text-[10px] font-black uppercase p-2 rounded-lg hover:bg-white/10 transition">Pending</button>
                <button onclick="setFilter('hold')"
                    class="flex-1 text-[10px] font-black uppercase p-2 rounded-lg hover:bg-white/10 transition">Hold</button>
                <button onclick="setFilter('confirmed')"
                    class="flex-1 text-[10px] font-black uppercase p-2 rounded-lg hover:bg-white/10 transition">Confirm</button>
            </div>

            <!-- List -->
            <div id="bookingList" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-center opacity-30 py-20 text-xs">No bookings found...</div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="flex-1 flex flex-col overflow-hidden bg-[#0a0c10]">

            <!-- Navbar: Global Stats -->
            <div class="h-20 border-b border-white/5 flex items-center px-10 gap-10">
                <div class="flex items-center gap-3">
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Total</span>
                    <span id="statTotal" class="text-xl font-black">0</span>
                </div>
                <div class="flex items-center gap-3">
                    <span
                        class="text-[10px] font-black text-gray-500 uppercase tracking-widest text-emerald-500">Confirmed</span>
                    <span id="statConfirmed" class="text-xl font-black text-emerald-500">0</span>
                </div>
                <div class="flex items-center gap-3">
                    <span
                        class="text-[10px] font-black text-gray-500 uppercase tracking-widest text-orange-400">Hold</span>
                    <span id="statHold" class="text-xl font-black text-orange-400">0</span>
                </div>
                <div class="flex items-center gap-3">
                    <span
                        class="text-[10px] font-black text-gray-500 uppercase tracking-widest text-red-500">Rejected</span>
                    <span id="statRejected" class="text-xl font-black text-red-500">0</span>
                </div>
            </div>

            <!-- Details Panel -->
            <div class="flex-1 p-10 overflow-y-auto">
                <div id="detailsPlaceholder" class="h-full flex flex-col items-center justify-center opacity-20">
                    <i class="fa-solid fa-file-invoice text-6xl mb-4"></i>
                    <p class="font-black uppercase tracking-widest text-xs">Select a booking to view details</p>
                </div>

                <div id="detailsContent" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-start justify-between mb-10">
                        <div>
                            <span id="detailId"
                                class="text-emerald-500 font-mono text-xl font-bold mb-2">#TRF12345</span>
                            <h2 id="detailName" class="text-5xl font-black uppercase tracking-tighter">PLAYER NAME</h2>
                        </div>
                        <div id="detailStatus" class="status-badge text-md px-4 py-2 mt-4 inline-block">STATUS</div>
                    </div>

                    <div class="grid grid-cols-2 gap-10">
                        <div class="stats-card space-y-6">
                            <div>
                                <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-2">
                                    Sports & Session</h3>
                                <p id="detailSport"
                                    class="text-lg font-black bg-white/5 p-3 rounded-xl border border-white/5">Sport
                                    Name</p>
                                <p id="detailSlot"
                                    class="text-lg font-black bg-white/5 p-3 rounded-xl border border-white/5 mt-2">Slot
                                    Time</p>
                            </div>
                            <div>
                                <h3 class="text-[10px] font-black text-blue-400 uppercase tracking-[0.2em] mb-2">Contact
                                    Details</h3>
                                <p id="detailPhone" class="text-lg font-black">+91 0000 0000</p>
                            </div>
                        </div>

                        <div class="stats-card flex flex-col justify-between">
                            <div>
                                <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-2">
                                    Total Amount</h3>
                                <p id="detailPrice" class="text-5xl font-black">‚Çπ0.00</p>
                            </div>
                            <!-- Actions -->
                            <div class="flex flex-wrap gap-2 pt-6">
                                <button onclick="action('confirm')"
                                    class="flex-1 bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl text-[10px] font-black uppercase"><i
                                        class="fa-solid fa-check mr-2"></i> Confirm</button>
                                <button onclick="action('hold')"
                                    class="flex-1 bg-orange-500 hover:bg-orange-400 p-3 rounded-xl text-[10px] font-black uppercase"><i
                                        class="fa-solid fa-pause mr-2"></i> Hold</button>
                                <button onclick="action('reject')"
                                    class="flex-1 bg-red-600 hover:bg-red-500 p-3 rounded-xl text-[10px] font-black uppercase"><i
                                        class="fa-solid fa-xmark mr-2"></i> Reject</button>
                                <button onclick="action('resend')"
                                    class="flex-1 bg-gray-700 hover:bg-gray-600 p-3 rounded-xl text-[10px] font-black uppercase w-full mt-2"><i
                                        class="fa-solid fa-qrcode mr-2"></i> Resend QR Pass</button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Message & Activity Log -->
                    <div class="mt-10 grid grid-cols-2 gap-10">
                        <div class="stats-card">
                            <h3 class="text-[10px] font-black text-purple-400 uppercase tracking-[0.2em] mb-4">Admin
                                Broadcast</h3>
                            <textarea id="customMsg" placeholder="Type a custom message to the customer..."
                                class="w-full h-32 bg-black/30 border border-white/5 rounded-2xl p-4 text-sm font-medium focus:ring-1 focus:ring-emerald-500 mb-4"></textarea>
                            <button onclick="action('broadcast')"
                                class="w-full bg-purple-600 hover:bg-purple-500 p-4 rounded-xl text-[10px] font-black uppercase">Send
                                Custom Message</button>
                        </div>
                        <div class="stats-card overflow-y-auto max-h-56">
                            <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Activity
                                Log</h3>
                            <div id="activityLog"
                                class="space-y-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">
                                <!-- Logs here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer: Global Live Feed -->
            <div class="h-10 bg-black/50 border-t border-white/5 flex items-center px-6 overflow-hidden">
                <div class="flex items-center gap-2 whitespace-nowrap animate-pulse">
                    <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    <span class="text-[8px] font-black opacity-40 uppercase tracking-[0.2em]">Real-time Feed ‚Äî</span>
                    <span id="liveFeed" class="text-[8px] font-black opacity-30 uppercase tracking-[0.2em]">Waiting for
                        events...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let bookings = [];
        let currentBookingId = null;
        let filterStatus = 'all';
        let socket;

        // AUTH
        async function login() {
            const pass = document.getElementById('adminPass').value;
            localStorage.setItem('adminKey', pass);
            const res = await fetch('/api/admin/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pass })
            });
            if (res.ok) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                initSocket();
                loadData();
            } else {
                alert('Invalid Password');
            }
        }

        // Check cache auth
        if (localStorage.getItem('adminKey')) {
            document.getElementById('adminPass').value = localStorage.getItem('adminKey');
            login();
        }

        function initSocket() {
            socket = io();
            socket.on('booking_update', () => {
                loadData();
                document.getElementById('liveFeed').innerText = "Booking Database Updated " + moment().format('HH:mm:ss');
            });
            socket.on('new_booking', (data) => {
                document.getElementById('liveFeed').innerText = `üö® New Booking: ${data.userName} (${data.sport})`;
                loadData();
            });
        }

        async function loadData() {
            const res = await fetch('/api/admin/bookings', {
                headers: { 'Authorization': localStorage.getItem('adminKey') }
            });
            bookings = await res.json();
            renderList();
            renderStats();
            if (currentBookingId) selectBooking(currentBookingId);
        }

        function renderStats() {
            document.getElementById('statTotal').innerText = bookings.length;
            document.getElementById('statConfirmed').innerText = bookings.filter(b => b.status === 'confirmed').length;
            document.getElementById('statHold').innerText = bookings.filter(b => b.status === 'hold').length;
            document.getElementById('statRejected').innerText = bookings.filter(b => b.status === 'rejected').length;
        }

        function setFilter(status) {
            filterStatus = status;
            renderList();
        }

        function renderList() {
            const list = document.getElementById('bookingList');
            const filtered = filterStatus === 'all' ? bookings : bookings.filter(b => b.status === filterStatus);

            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center opacity-30 py-20 text-xs">No bookings found...</div>';
                return;
            }

            list.innerHTML = filtered.map(b => `
                <div onclick="selectBooking('${b.id}')" class="booking-item p-4 ${currentBookingId === b.id ? 'active' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-mono text-emerald-500 font-bold">#${b.id}</span>
                        <span class="status-badge status-${b.status}">${b.status}</span>
                    </div>
                    <div class="font-black text-sm text-white uppercase">${b.userName}</div>
                    <div class="flex justify-between items-center mt-2 opacity-50 text-[10px] font-bold uppercase tracking-widest">
                        <span>${b.sport}</span>
                        <span>${b.slot}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectBooking(id) {
            currentBookingId = id;
            renderList();
            const b = bookings.find(x => x.id === id);

            document.getElementById('detailsPlaceholder').classList.add('hidden');
            document.getElementById('detailsContent').classList.remove('hidden');

            document.getElementById('detailId').innerText = `#${b.id}`;
            document.getElementById('detailName').innerText = b.userName;
            document.getElementById('detailSport').innerText = b.sport;
            document.getElementById('detailSlot').innerText = b.slot;
            document.getElementById('detailPhone').innerText = `+91 ${b.userPhone}`;
            document.getElementById('detailPrice').innerText = `‚Çπ${b.amount}`;

            const badge = document.getElementById('detailStatus');
            badge.innerText = b.status;
            badge.className = `status-badge text-md px-4 py-2 mt-4 inline-block status-${b.status}`;

            const logs = document.getElementById('activityLog');
            logs.innerHTML = b.log.map(l => `
                <div class="flex items-start gap-3 border-l-2 border-white/10 pl-4 py-1">
                    <span class="text-white opacity-40 whitespace-nowrap">${moment(l.time).format('HH:mm')}</span>
                    <span>${l.msg}</span>
                </div>
            `).reverse().join('');
        }

        async function action(type) {
            if (!currentBookingId) return;
            const customMsg = document.getElementById('customMsg').value;

            const res = await fetch(`/api/admin/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('adminKey')
                },
                body: JSON.stringify({
                    id: currentBookingId,
                    type,
                    message: customMsg
                })
            });

            if (res.ok) {
                document.getElementById('customMsg').value = '';
                loadData();
            } else {
                alert('Action failed');
            }
        }
    </script>
</body>

</html>